<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js oranda-dark">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Build system - PLX docs</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="The documentation includes how to install, use and develop PLX.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">
        <link rel="stylesheet" href="oranda-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="book.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "oranda-dark" : "oranda-dark";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('orandamdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('orandamdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('orandamdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('oranda-dark')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="install.html"><strong aria-hidden="true">1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="why.html"><strong aria-hidden="true">2.</strong> Why?</a></li><li class="chapter-item expanded "><a href="CHANGELOG.html"><strong aria-hidden="true">3.</strong> Changelog</a></li><li class="chapter-item expanded "><a href="report.html"><strong aria-hidden="true">4.</strong> PDG-Report</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="project-description.html"><strong aria-hidden="true">4.1.</strong> Project-description</a></li><li class="chapter-item expanded "><a href="architecture.html"><strong aria-hidden="true">4.2.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="mokups.html"><strong aria-hidden="true">4.3.</strong> Mockups</a></li><li class="chapter-item expanded "><a href="landing-page.html"><strong aria-hidden="true">4.4.</strong> Landing page</a></li><li class="chapter-item expanded "><a href="technical-choice.html"><strong aria-hidden="true">4.5.</strong> Technical choice</a></li><li class="chapter-item expanded "><a href="work-process.html"><strong aria-hidden="true">4.6.</strong> Work process</a></li><li class="chapter-item expanded "><a href="pipeline-ci-cd.html"><strong aria-hidden="true">4.7.</strong> Pipeline CI/CD</a></li></ol></li><li class="chapter-item expanded "><a href="features.html"><strong aria-hidden="true">5.</strong> Features development</a></li><li class="chapter-item expanded "><a href="teachers.html"><strong aria-hidden="true">6.</strong> Experience for teachers</a></li><li class="chapter-item expanded "><a href="dev.html"><strong aria-hidden="true">7.</strong> Development</a></li><li class="chapter-item expanded "><a href="contribution.html"><strong aria-hidden="true">8.</strong> Contribution guide</a></li><li class="chapter-item expanded "><a href="design.html"><strong aria-hidden="true">9.</strong> Design</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="exos.html"><strong aria-hidden="true">9.1.</strong> Exos management</a></li><li class="chapter-item expanded "><a href="build.html" class="active"><strong aria-hidden="true">9.2.</strong> Build system</a></li></ol></li><li class="chapter-item expanded "><a href="../../index.html"><strong aria-hidden="true">10.</strong> Return to the Home page</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="oranda-dark">Oranda Dark</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="oranda-light">Oranda Light</button></li>

                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">PLX docs</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="build-system-design"><a class="header" href="#build-system-design">Build system design</a></h1>
<p>Design brainstorming on</p>
<blockquote>
<p>How to structure a system to build C, C++ and Java, to support various dependencies and reduce/remove manual configurations to a minimum ?<br />
How to make the build cache mostly invisible ?</p>
</blockquote>
<p>The structure and formats is not ready yet, but it will look something like Delibay (course repos + course info + skills list + exos list per skills) and one folder per exo.</p>
<pre><code class="language-sh">cppexos # exos repository, C++ as example here
  course.toml # define your course info
  skills.toml # define your skills info and order
  structs # first skill
    exos.toml # exos definition in this skill
    mega-dog # first exo in this skill
      dog.cpp
    unit-dog # second exo with unit tests in GoogleTest
      dog.cpp
  pointers # second skill
    exos.toml
    on-functions # first exo in this skill with 3 files
      libparse.c
      libparse.h
      main.cpp
    debug # second exo in this skill with one file
      crash.cpp
</code></pre>
<h2 id="build-challenges"><a class="header" href="#build-challenges">Build challenges</a></h2>
<ol>
<li><strong>Problem 1</strong>: How to detect project type ?
<ol>
<li>How to avoid the need to define the compilation type ? How to guess it instead ?</li>
</ol>
</li>
<li><strong>Problem 2</strong>: How to manage trivial and non trivial build situations ?
<ol>
<li>For trivial situations, how should we name the target ?</li>
<li>How to define some dependencies like GoogleTest, Unity or other test runners or libraries</li>
<li>How to install those dependencies ? How to accept xmake prompt to install ?</li>
</ol>
</li>
<li><strong>Problem 3</strong>: How to make build system almost invisible ?
<ol>
<li>Having 3 additional elements per exo folder is too much noise (<code>xmake.lua</code>, <code>.xmake</code> and <code>build</code>), it would better to have most only build related elements at root of the repository</li>
<li>We cannot have a common flat <code>build</code> folder for all exos, because it will create strange errors. We cannot trash it before each exo, because we would loose the big speed improvement of build cache when running all exos or running an exo done in the past.</li>
<li>How to differentiate generated and manually written build configurations ?</li>
</ol>
</li>
</ol>
<h2 id="build-strategies"><a class="header" href="#build-strategies">Build strategies</a></h2>
<p><strong>Solution to problem 1</strong>: Using existing configuration or guess how to build trivial cases</p>
<ol>
<li>Define <code>ExoType = None</code></li>
<li>If the exo folder contains a <code>xmake.lua</code>, it is used to build: <code>ExoType = xmake</code></li>
<li>Otherwise, if it contains any .c or .cpp file: <code>ExoType = xmake</code></li>
<li>Otherwise, if it contains any .java, using javac strategy: <code>ExoType = java</code></li>
</ol>
<p>If <code>ExoType == None</code> at this point, throw an error because this is not possible to build this exo...</p>
<p><strong>Solution to problem 2</strong>:</p>
<ul>
<li>
<p>If <code>ExoType == java</code>, only trivial situations are supported: with <code>javac</code> directly, running the following command <code>javac -d path/to/build/folder Main.java</code>. The main file should be named <code>Main.java</code>. It will be ran with <code>java -classpath path/to/build/folder/ Main</code>.</p>
</li>
<li>
<p>If <code>ExoType == xmake</code> and there is no existing <code>xmake.lua</code>, we create it on the fly (only the first comment will be included)</p>
<pre><code class="language-lua">-- Autogenerated by PLX based on guess: xmake + cpp + c. Do not edit directly.
target("exo")
add_files("**.cpp") -- add this line only when .cpp files have been detected
add_files("**.c") -- add this line only when .c files have been detected
-- it's possible to have both C and C++ at the same time but only one `main()` function
</code></pre>
</li>
<li>
<p>In case, we define in exo metadata external libraries or xmake packages (here <code>pcosynchro</code> as library and <code>gtest</code> as package), we dynamically generate xmake instructions <code>add_requires</code>+<code>add_packages</code> and <code>add_links</code>.</p>
<pre><code class="language-lua">add_requires("gtest")

target("exo")
add_files("**.cpp")
add_packages("gtest")
add_links("pcosynchro")
</code></pre>
</li>
<li>
<p>If this is not possible to solve the build situation with the above possilities, the teacher needs to create <code>xmake.lua</code> by hand. The target must be also be named <code>exo</code> so PLX can detect and run it via <code>xmake run exo</code>.</p>
</li>
</ul>
<p><strong>Solution to problem 3</strong>: Group all build folders in a single folder <code>build</code> at root of repos:</p>
<ul>
<li>Xmake can use a specific config build folder and <code>xmake.lua</code>, <code>javac</code> support a custom output folder, so we make build files almost invisible. This also has the advantage of removing ambiguity on if a <code>xmake.lua</code> has been written by a teacher or has been dynamically generated, as they would be located in different folders: the dynamic config inside the <code>build/...</code> structure, the hand written one in the exo folder.</li>
</ul>
<!-- - Example with 2 exos folders `structs/dog/` and `structs/cat/` -> `build/structs/dog/` and `build/structs/cat/`. Those last folders would contain `.xmake` and `build` from Xmake and also dynamically generated `xmake.lua`. -->
<h2 id="global-overview"><a class="header" href="#global-overview">Global overview</a></h2>
<p>Here is an overview example, considering the previous structure but this time including build files</p>
<pre><code class="language-sh">cppexos
  course.toml
  skills.toml
  structs
    exos.toml
    mega-dog
      dog.cpp
    unit-dog
      dog.cpp
      xmake.lua # special case with need of hand written config
  pointers
    exos.toml
    on-functions
      libparse.c
      libparse.h
      main.cpp
    debug
      crash.cpp

  ...

  .gitignore # must contains "build" folder
  build # common build folder, same structure as above inside,
        # but with build config and cache instead of code
    structs
      mega-dog
        xmake.lua # dynamically generated config file
        ## Generated by xmake for this specific exo
        .xmake
        build
    pointers
      on-functions
        xmake.lua # dynamically generated config file
        ## Generated by xmake for this specific exo
        .xmake
        build
          ...
</code></pre>
<p><strong>Xmake example in C++</strong>: Let's say we are doing the <code>structs/mega-dog</code> exo editing <code>dog.cpp</code>, here are the steps behind the scenes</p>
<ol>
<li>Compilation
<ol>
<li>We detect this exo has no existing <code>xmake.lua</code> but has <code>.cpp</code> files so the exo type is <code>xmake</code>.</li>
<li>Intermediate folders are created for path <code>build/structs/dog</code> if necessary</li>
<li>The trivial config is created under <code>build/structs/dog/xmake.lua</code>
<pre><code class="language-lua">-- Autogenerated by PLX based on guess: xmake + cpp. Do not edit directly.
target("exo")
add_files("**.cpp")
</code></pre>
</li>
<li>PLX runs the following command <code>xmake build -F build/structs/dog/xmake.lua -P structs/dog/</code> to indicate source file and build config file.</li>
</ol>
</li>
<li>Execution
<ol>
<li>PLX runs the following command <code>xmake run exo -F build/structs/dog/xmake.lua</code></li>
</ol>
</li>
</ol>
<p><strong>Java example</strong>: Let's say we are doing the <code>try-catch/except-me</code> exo editing <code>Main.java</code>, here are the steps behind the scenes</p>
<pre><code class="language-sh">cppexos
  course.toml
  skills.toml
  try-catch
    exos.toml
    except-me
      Main.java
      Person.java
      Party.java
  build
    try-catch
      except-me
        Main.class # generated by javac
</code></pre>
<ol>
<li>Compilation
<ol>
<li>We detect this exo contain <code>*.java</code> files so the exo type is <code>java</code>.</li>
<li>Intermediate folders are created for path <code>build/try-catch/except-me/</code> if necessary</li>
<li>PLX runs <code>javac -d build/try-catch/except-me/ Main.java</code></li>
</ol>
</li>
<li>Execution
<ol>
<li>PLX runs <code>java -classpath build/try-catch/except-me/ Main</code></li>
</ol>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="exos.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="exos.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
