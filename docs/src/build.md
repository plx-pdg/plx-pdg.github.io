# Build system design

Design brainstorming on
> How to structure a system to build C, C++ and Java, to support various dependencies and reduce/remove manual configurations to a minimum ?
> How to make the build cache mostly invisible ?

```sh
cppexos # exos repository, C++ as example here
  course.plx # define your course info
  skills.plx # define your skills info and order
  struct-and-enums # first skill
    exos.plx # exos definition of this skill
    mega-dog # first exo in this skill
      dog.cpp
    unit-dog # second exo with unit tests in GoogleTest
      dog.cpp
  pointers # second skill
    exos.plx # exos definition of this skill
    on-functions # first exo in this skill with 3 files
      libparse.c
      libparse.h
      main.cpp
    on-arrays # second exo in this skill
    debug # third exo in this skill with one file
      crash.cpp
  ...
  .gitignore # must contains "build" folder
  build # common build folder
    ## Generated by xmake but only at root
    .xmake
    build
```

## Build challenges

1. **Problem 1**: How to detect project type ?
    1. How to avoid the need to define the compilation type ? How to guess it instead ?
1. **Problem 2**: How to manage trivial and non trivial build situations ?
    1. For trivial situations, how should we name the target ?
    1. How to define some dependencies like GoogleTest, Unity or other test runners or libraries
    1. How to install those dependencies ? How to accept xmake prompt to install ?
1. **Problem 3**: How to make build system almost invisible ?
    1. Having 3 additional elements per exo folder is too much noise (`xmake.lua`, `.xmake` and `build`), it would better to have most only build related elements at root of the repository
    1. We cannot have a common flat `build` folder for all exos, because it will create strange errors. We cannot trash it before each exo, because we would loose the big speed improvement of build cache when running all exos or running an exo done in the past.
    1. How to differentiate generated and manually written build configurations ?

## Build strategies
**Solution to problem 1**: Using existing configuration or guess how to build trivial cases
1. Define `ExoType = None`
1. If the exo folder contains a `xmake.lua`, it is used to build: `ExoType = xmake`
1. Otherwise, if it contains any .c or .cpp file: `ExoType = xmake`
1. Otherwise, if it contains any .java, using javac strategy: `ExoType = java`

If `ExoType == None` at this point, throw an error because this is not possible to build this exo...

**Solution to problem 2**: 
- If `ExoType == java`, only trivial situations are supported: with `javac` directly, running the following command `javac -d path/to/build/folder Main.java`. The main file should be named `Main.java`. It will be ran with `java -classpath path/to/build/folder/ Main`.
- If `ExoType == xmake` and there is no existing `xmake.lua`, we create it on the fly (only the first comment will be included)
    ```lua
    -- Autogenerated by PLX based on guess: xmake + cpp + c. Do not edit directly.
    target("exo")
    add_files("**.cpp") -- add this line only when .cpp files have been detected
    add_files("**.c") -- add this line only when .c files have been detected
    -- it's possible to have both C and C++ at the same time but only one `main()` function
    ```
- In case, we define in exo metadata external libraries or xmake packages (here `pcosynchro` as library and `gtest` as package), we dynamically generate xmake instructions `add_requires`+`add_packages` and `add_links`.
    ```lua
    add_requires("gtest")

    target("exo")
    add_files("**.cpp")
    add_packages("gtest")
    add_links("pcosynchro")
    ```

- If this is not possible to solve the build situation with the above possilities, the teacher needs to create `xmake.lua` by hand. The target must be also be named `exo` so PLX can detect and run it via `xmake run exo`

**Solution to problem 3**: Group all build folders in a single folder `build` at root of repos:
- Xmake can use a specific config build folder and `xmake.lua`, `javac` support a custom output folder, so we make build files almost invisible. This also has the advantage of removing ambiguity on if a `xmake.lua` has been written by a teacher or has been dynamically generated, as they would be located in different folders: the dynamic config inside the `build/...` structure, the hand written one in the exo folder.
- Example with 2 exos folders `structs/dog/` and `structs/cat/` -> `build/structs/dog/` and `build/structs/cat/`. Those last folders would contain `.xmake` and `build` from Xmake. Here is the final structure (overview with only what matters).
```sh
structs # just an example skill
  exos.plx
  dog
    dog.c
  cat
    cat.c
build # the single visible folder at root related to builds
  structs
    dog
      .xmake
      build
    cat
      .xmake
      build
```
- The final command to build `dog.c` will be run at repos' root: `xmake build -F build/structs/dog/xmake.lua -P structs/dog/`.

