## Build system design

Design brainstorming on
> How to structure a system to build C, C++ and Java, to support various dependencies and reduce/remove manual configurations to a minimum ?
> How to make the build cache mostly invisible ?

```sh
cppexos # exos repository
  course.plx
  skills.plx
  struct-and-enums # first skill
    mega-dog # first exo in this skill
      dog.c
      dog.plx # ??
    unit-dog # second exo with unit tests in GoogleTest
      dog.cpp
      dog.plx # ??
  pointers # second skill
    on-functions # first exo in this skill with 3 files
      lib.c
      lib.h
      main.c
    on-arrays # second exo in this skill
    debug # third exo in this skill with one file
      crash.c
  build
    ## Generated by xmake but only at root
    .xmake
    build
```
### Build challenges

1. Problem 1: detect project type
    1. We have to detect whether this is a C/C++ exo (or a mix) or a Java exo when we begin the exo
1. Problem 2: manage non trivial build situations
    1. We have to apply a basic build configuration without any dependencies taking all code files recursively (take all `.cpp` in folder and subfolders if this is a C++ project)
    1. We can have some dependencies like GoogleTest, Unity or other test runners or libraries
1. Problem 3: move build folder and trival configuration from exo folder
    1. Having 3 additional file/folders per exo folder is too much noise (`xmake.lua`, `.xmake` and `build`), it would better to have most of the times only build related elements at root of the repository
    1. We cannot have a common `build` folder for all exos, because it probably create strange errors or in case we trash it before each exo, we loose the big speed improvement of build cache when running all exos or running an exo done in the past


**Solution to problem 1**: 
ProjectType = None
1. If the exo folder contains a `xmake.lua`, it is used to build
  ProjectType = xmake
1. Otherwise, if it contains any .c or .cpp file
  ProjectType = xmake
1. Otherwise, if it contains any .java, using javac strategy
  ProjectType = java

If ProjectType = None at this point, throw an error this is not possible to build this exo

**Solution to problem 2**: 
- If this is not possible to solve the build situation with the above possilities, the teacher needs to create `xmake.lua` by hand. The target must be named `exo` so PLX can detect and run it.
- In case no `xmake.lua`, we create on the fly a `xmake.lua`, we adapt the globbing of files to depending on the detected files
    ```lua
    target("tests")
    add_files("**.cpp") -- add this line only when .cpp files have been detected
    add_files("**.c") -- add this line only when .c files have been detected
    ```
TODO continue
```lua
add_requires("gtest")

target("tests")
add_files("*.cpp")
add_packages("gtest")
add_links("pcosynchro")
```

**Solution to problem 3**: Group all build folders in a single folder `.build` at root of repos:
- Xmake can manage build cache in a separated folder and use a given `xmake.lua`, so with 2 exos folders `structs/dog/` and `structs/cat/`, the root folder `.build/` would contain `.build/structs/dog/` and `.build/structs/cat/`. Those folders would contain `.xmake` and `build` from Xmake. Here is the final structure.
```sh
structs
  dog
    dog.c
  cat
    cat.c
.build # the single visible folder at root related to builds
  structs
    dog
      .xmake
      build
    cat
      .xmake
      build
```
